#!/bin/sh

portOffset=150

# Test with peregrine.test.backend=threads | processes

write_configs() {

    factors="$1"
    configs="$2"
    backend="$3"

    for factor in $factors; do
        for config in $configs; do

            name_prefix="T"

            if [ "$backend" == "processes" ]; then
                name_prefix="P"
            fi

            basename=$factor:$config
            name=$name_prefix:$factor:$config
            portOffset=$(expr $portOffset + 50)
            pathname=$(echo $basename | sed -e 's/:/_/g')

            echo $name
            echo factor=$factor
            echo portOffset=$portOffset
            cat > conf/peregrine-test-$basename.py <<EOF

## AUTOGENERATED.  DO NOT EDIT.

NAME="$name"
SCRATCH="/tmp/integration/test-$pathname"

TEST_LOGS="/var/lib/integration/peregrine/test-$pathname"

WEBDIR="/test-$pathname"

TEST_COMMAND="ulimit -n 100000 && export HOSTNAME=localhost && export ANT_OPTS='-Xmx512M -Dperegrine.test.backend=$backend -Dperegrine.test.portOffset=$portOffset -Dmulti.factors=$factor -Dmulti.configs=$config' && time ant test"

POST_COMMAND="export ANT_OPTS=-Xmx512M && ant test-report"

REPO="https://burtonator:redapplekittycat@bitbucket.org/burtonator/peregrine"

OUTPUT = { 'test-reports' : 'target/test-reports'  }

OLD_AGE=1 * 60 * 60

TIMEOUT=30*60

EOF

        echo $tmpl

        done
    done

}

write_configs "1 2" "1:1:1 1:1:2 1:1:4 1:2:3 2:1:1 2:1:4" "threads"
write_configs "3" "1:1:1" "processes"
