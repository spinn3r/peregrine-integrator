#!/bin/sh

FACTORS="1 2"
CONFIGS="1:1:1 1:1:2 1:1:4 1:2:3 2:1:1 2:1:4"

portOffset=150

# Test with peregrine.test.backend=threads | processes

write_configs() {

    for factor in $FACTORS; do
        for config in $CONFIGS; do

            name_prefix="T"
            backend="threads"

            if [ "$factor" != "1" ]; then
                name_prefix="P"
                backend="processes"
            fi

            basename=$factor:$config
            name=$name_prefix:$factor:$config
            portOffset=$(expr $portOffset + 50)
            pathname=$(echo $basename | sed -e 's/:/_/g')

            echo $name
            echo factor=$factor
            echo portOffset=$portOffset
            cat > conf/peregrine-test-$basename.py <<EOF

## AUTOGENERATED.  DO NOT EDIT.

NAME="$name"
SCRATCH="/tmp/integration/test-$pathname"

TEST_LOGS="/var/lib/integration/peregrine/test-$pathname"

WEBDIR="/test-$pathname"

TEST_COMMAND="export HOSTNAME=localhost && export ANT_OPTS='-Xmx512M -Dperegrine.test.backend=$backend -Dperegrine.test.portOffset=$portOffset -Dmulti.factors=$factor -Dmulti.configs=$config' && time ant test"

POST_COMMAND="export ANT_OPTS=-Xmx512M && ant test-report"

REPO="https://burtonator:redapplekittycat@bitbucket.org/burtonator/peregrine"

OUTPUT = { 'test-reports' : 'target/test-reports'  }

OLD_AGE=3 * 24 * 60 * 60

TIMEOUT=30*60

EOF

        echo $tmpl

        done
    done

}

write_configs 
